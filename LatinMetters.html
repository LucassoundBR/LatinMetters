<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LatinMetters // @lucas.sound</title>
    <!-- Font: Share Tech Mono Only -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #e0e0e0;
            --bg: #080808;
            --panel-bg: rgba(15, 15, 15, 0.95);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #888888;
            --highlight: #ffffff;
            --sidebar-width: 220px;
            --font-main: 'Share Tech Mono', monospace;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: var(--bg);
            overflow: hidden;
            color: var(--primary);
            font-family: var(--font-main);
            user-select: none;
        }

        /* --- LEFT SIDEBAR UI --- */
        #ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--border);
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            overflow: hidden;
            /* Prevent container scroll */
        }

        #control-bar {
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            /* Internal scroll only */
            height: 100%;
            scrollbar-width: none;
        }

        #control-bar::-webkit-scrollbar {
            display: none;
        }

        /* HEADER SECTION */
        .brand-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        .brand {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #fff;
        }

        .insta-link {
            font-size: 12px;
            pointer-events: auto;
            text-decoration: none;
            color: var(--primary);
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .insta-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .version-label {
            font-size: 10px;
            opacity: 0.4;
            letter-spacing: 1px;
            margin-top: 2px;
        }

        /* CONTROLS */
        .lang-switch {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }

        .lang-btn {
            background: transparent;
            border: none;
            color: var(--accent);
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            padding: 4px 0;
            border-bottom: 1px solid transparent;
            font-family: inherit;
            transition: 0.2s;
        }

        .lang-btn:hover {
            color: var(--primary);
        }

        .lang-btn.active {
            color: var(--highlight);
            border-bottom-color: var(--highlight);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        label span {
            color: var(--highlight);
            font-variant-numeric: tabular-nums;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            margin-top: -6px;
            border: 1px solid rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.15);
        }

        select {
            background: rgba(30, 30, 30, 1);
            color: var(--primary);
            border: 1px solid var(--border);
            padding: 8px 10px;
            font-family: inherit;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            width: 100%;
            transition: border-color 0.2s;
        }

        select:hover {
            border-color: var(--accent);
        }

        .toggle-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 10px;
            font-size: 11px;
            cursor: pointer;
            font-family: inherit;
            border-radius: 4px;
            text-align: center;
            transition: all 0.2s;
            letter-spacing: 0.5px;
            flex: 1;
        }

        .toggle-btn:hover {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
        }

        .toggle-btn.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        /* FOOTER INFO */
        .info-footer {
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ATALHOS DESTACADOS */
        .shortcuts {
            font-size: 12px;
            color: #fff;
            opacity: 0.8;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 4px;
            border-left: 2px solid var(--primary);
        }

        .shortcuts b {
            color: #fff;
            text-decoration: underline;
        }

        .origin {
            font-size: 10px;
            opacity: 0.4;
            letter-spacing: 1px;
        }

        #click-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 13px;
            font-weight: 700;
            opacity: 1;
            /* Visible by default */
            pointer-events: none;
            transition: opacity 0.5s;
            padding: 15px 30px;
            border: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.9);
            letter-spacing: 2px;
            z-index: 200;
            text-align: center;
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 180px;
            }

            #ui-container.hidden {
                transform: translateX(-100%);
            }

            #fsBtn {
                display: none !important;
            }

            .shortcuts {
                display: none;
            }
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js",
            "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/"
        }
    }
    </script>
</head>

<body>

    <div id="click-hint">CLICK TO ENABLE AUDIO</div>

    <!-- LEFT SIDEBAR -->
    <div id="ui-container">
        <div id="control-bar">

            <div class="brand-section">
                <div class="brand">LatinMetters</div>
                <a href="https://instagram.com/lucas.sound" target="_blank" class="insta-link">@lucas.sound</a>
                <div class="version-label">v5.0 Stable</div>
            </div>

            <div class="lang-switch">
                <button class="lang-btn active" onclick="setLang('en')">EN</button>
                <button class="lang-btn" onclick="setLang('pt')">PT</button>
                <button class="lang-btn" onclick="setLang('es')">ES</button>
            </div>

            <!-- GROUP 1: VISUALS -->
            <div class="control-group">
                <label><span data-i18n="amp">AMP</span> <span id="ampVal">30</span></label>
                <input type="range" id="ampSlider" min="10" max="100" value="30">
            </div>

            <div class="control-group">
                <label><span data-i18n="depth">DEPTH</span> <span id="depthVal">64</span></label>
                <input type="range" id="depthSlider" min="32" max="128" value="64" step="16">
            </div>

            <div class="control-group">
                <label><span data-i18n="speed">SPEED</span> <span id="speedVal">4</span></label>
                <input type="range" id="speedSlider" min="1" max="10" value="4">
            </div>

            <div class="control-group">
                <label>FFT SIZE</label>
                <select id="fftSelect">
                    <option value="1024">1024</option>
                    <option value="2048" selected>2048</option>
                    <option value="4096">4096</option>
                    <option value="8192">8192</option>
                    <option value="16384">16384</option>
                </select>
            </div>

            <div class="control-group">
                <label data-i18n="palette">PALETTE</label>
                <select id="paletteSelect">
                    <option value="dreamy">Dreamy</option>
                    <option value="ocean">Midnight Sea</option>
                    <option value="plasma">Plasma</option>
                    <option value="heat">Heat</option>
                    <option value="amazonia">Amazonia</option>
                    <option value="jinx">Jinx</option>
                    <option value="spectral">Nebula</option>
                    <option value="golden">Luxury</option>
                    <option value="kawaii">Kawaii</option>
                    <option value="metal_gear">Metal Gear</option>
                </select>
            </div>

            <div class="control-group">
                <label data-i18n="mode">MODE</label>
                <select id="modeSelect">
                    <option value="solid" selected>SOLID</option>
                    <option value="bars">BARS</option>
                    <option value="wire">WIRE</option>
                    <option value="lines">LINES</option>
                    <option value="dots">DOTS</option>
                </select>
            </div>

            <div class="control-group">
                <label data-i18n="view">VIEW</label>
                <select id="viewSelect">
                    <option value="iso">ISO</option>
                    <option value="front">FRONT</option>
                    <option value="side">SIDE</option>
                    <option value="top">TOP</option>
                </select>
            </div>

            <div class="control-group" style="flex-direction: row; align-items: flex-end; gap: 8px;">
                <button id="sizeBtn" class="toggle-btn active" data-i18n="size_full">SIZE: FULL</button>
                <button id="gridBtn" class="toggle-btn active" data-i18n="grid_on">GRID: ON</button>
            </div>

            <div class="control-group" style="flex-direction: row; align-items: flex-end; gap: 8px;">
                <button id="srcBtn" class="toggle-btn" data-i18n="src_mic">SOURCE: MIC</button>
                <button id="rotBtn" class="toggle-btn" data-i18n="rot_off">ROT: OFF</button>
                <button id="fsBtn" class="toggle-btn">⛶</button>
            </div>

            <div class="info-footer">
                <div class="shortcuts">
                    <b>[TAB]</b> <span data-i18n="sc_hide">HIDE UI</span><br>
                    <b>[SPACE]</b> <span data-i18n="sc_pause">PAUSE</span>
                </div>
                <div class="origin">MADE IN BRAZIL</div>
            </div>

        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/examples/jsm/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/examples/jsm/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/examples/jsm/postprocessing/UnrealBloomPass.js';
        import { ShaderPass } from 'three/examples/jsm/postprocessing/ShaderPass.js';
        import { FXAAShader } from 'three/examples/jsm/shaders/FXAAShader.js';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        // --- I18N DATA ---
        const i18n = {
            en: {
                amp: "AMP", depth: "DEPTH", speed: "SPEED", palette: "PALETTE",
                mode: "MODE", view: "VIEW", rotation: "ROTATION",
                size_full: "SIZE: FULL", size_half: "SIZE: HALF",
                grid_on: "GRID: ON", grid_off: "GRID: OFF", click_hint: "CLICK TO ENABLE AUDIO",
                rot_off: "ROT: OFF", rot_slow: "ROT: SLOW", rot_fast: "ROT: FAST",
                src_mic: "SOURCE: MIC", src_sys: "SOURCE: SYSTEM",
                sc_hide: "HIDE UI", sc_pause: "PAUSE",

                mode_solid: "SOLID", mode_wire: "WIRE", mode_lines: "LINES", mode_dots: "DOTS", mode_bars: "BARS",
                view_iso: "ISO", view_front: "FRONT", view_side: "SIDE", view_top: "TOP",
                pal_dreamy: "Dreamy", pal_ocean: "Midnight Sea", pal_plasma: "Plasma", pal_heat: "Heat",
                pal_amazonia: "Amazonia", pal_jinx: "Jinx", pal_spectral: "Nebula", pal_golden: "Luxury",
                pal_kawaii: "Kawaii", pal_metal_gear: "Metal Gear"
            },
            pt: {
                amp: "AMP", depth: "PROFUNDIDADE", speed: "VELOCIDADE", palette: "PALETA",
                mode: "MODO", view: "VISTA", rotation: "ROTAÇÃO",
                size_full: "TAMANHO: CHEIO", size_half: "TAMANHO: METADE",
                grid_on: "GRADE: ON", grid_off: "GRADE: OFF", click_hint: "CLIQUE PARA ATIVAR ÁUDIO",
                rot_off: "ROT: OFF", rot_slow: "ROT: LENTA", rot_fast: "ROT: RÁPIDA",
                src_mic: "FONTE: MIC", src_sys: "FONTE: SISTEMA",
                sc_hide: "OCULTAR UI", sc_pause: "PAUSAR",

                mode_solid: "SÓLIDO", mode_wire: "ARAME", mode_lines: "LINHAS", mode_dots: "PONTOS", mode_bars: "BARRAS",
                view_iso: "ISO", view_front: "FRENTE", view_side: "LADO", view_top: "TOPO",
                pal_dreamy: "Sonho", pal_ocean: "Mar da Meia-noite", pal_plasma: "Plasma", pal_heat: "Calor",
                pal_amazonia: "Amazônia", pal_jinx: "Jinx", pal_spectral: "Nebulosa", pal_golden: "Luxo",
                pal_kawaii: "Kawaii", pal_metal_gear: "Metal Gear"
            },
            es: {
                amp: "AMP", depth: "PROFUNDIDAD", speed: "VELOCIDAD", palette: "PALETA",
                mode: "MODO", view: "VISTA", rotation: "ROTACIÓN",
                size_full: "TAMAÑO: COMP.", size_half: "TAMAÑO: MITAD",
                grid_on: "REJILLA: ON", grid_off: "REJILLA: OFF", click_hint: "CLIC PARA ACTIVAR AUDIO",
                rot_off: "ROT: OFF", rot_slow: "ROT: LENTA", rot_fast: "ROT: RÁPIDA",
                src_mic: "FUENTE: MIC", src_sys: "FUENTE: SISTEMA",
                sc_hide: "OCULTAR UI", sc_pause: "PAUSAR",

                mode_solid: "SÓLIDO", mode_wire: "ALAMBRE", mode_lines: "LÍNEAS", mode_dots: "PUNTOS", mode_bars: "BARRAS",
                view_iso: "ISO", view_front: "FRENTE", view_side: "LADO", view_top: "ARRIBA",
                pal_dreamy: "Ensueño", pal_ocean: "Mar de Medianoche", pal_plasma: "Plasma", pal_heat: "Calor",
                pal_amazonia: "Amazonia", pal_jinx: "Jinx", pal_spectral: "Nebulosa", pal_golden: "Lujo",
                pal_kawaii: "Kawaii", pal_metal_gear: "Metal Gear"
            }
        };

        let currentLang = 'en';
        let rotState = 0;
        let audioSource = 'mic';

        window.setLang = (lang) => {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.lang-btn')).find(btn => btn.innerText.toLowerCase() === lang);
            if (activeBtn) activeBtn.classList.add('active');

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key.includes('size')) el.innerText = config.halfDepth ? i18n[lang].size_half : i18n[lang].size_full;
                else if (key.includes('grid')) el.innerText = gridHelper && gridHelper.visible ? i18n[lang].grid_on : i18n[lang].grid_off;
                else if (key === 'rot_off') el.innerText = i18n[lang][['rot_off', 'rot_slow', 'rot_fast'][rotState]];
                else if (key === 'src_mic') el.innerText = audioSource === 'mic' ? i18n[lang].src_mic : i18n[lang].src_sys;
                else el.innerText = i18n[lang][key];
            });
            const hint = document.getElementById('click-hint');
            if (hint) hint.innerText = i18n[lang].click_hint;
            translateOptions('modeSelect', 'mode_', lang);
            translateOptions('viewSelect', 'view_', lang);
            translateOptions('paletteSelect', 'pal_', lang);
        };

        function translateOptions(id, prefix, lang) {
            const select = document.getElementById(id);
            if (!select) return;
            Array.from(select.options).forEach(opt => {
                const key = prefix + opt.value;
                if (i18n[lang][key]) opt.innerText = i18n[lang][key];
            });
        }

        // --- CORE STATE ---
        let audioContext, analyser, dataArray, mediaStream;
        let isRunning = false;
        let isPaused = false;
        let frameCount = 0;
        let mesh, geometry, material;
        let labelGroup = new THREE.Group();
        let gridHelper;
        let isUiVisible = true;
        let binIndexLUT = null;

        let config = {
            width: 256, depth: 64, halfDepth: false,
            speedDivisor: 4, amp: 30, palette: 'dreamy',
            displayMode: 'solid'
        };

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) { config.width = 128; config.depth = 48; }

        const palettes = {
            dreamy: ['#000004', '#3b0f70', '#8c2981', '#fe9f6d'],
            ocean: ['#010a1a', '#003049', '#023e8a', '#0077b6'],
            plasma: ['#10002b', '#7b2cbf', '#ff006e', '#ffdde1'],
            heat: ['#000000', '#5a100c', '#c44e05', '#d4a017'],
            amazonia: ['#000a00', '#002200', '#005f41', '#00ff41'],
            jinx: ['#240046', '#7b2cbf', '#4361ee', '#3a0ca3'],
            spectral: ['#2e003e', '#7f2982', '#c60055', '#e67e00'],
            golden: ['#050403', '#5e4b35', '#b08d55', '#96700e'],
            kawaii: ['#2b0f31', '#ff7eb9', '#ff9a8b', '#9b59b6'],
            metal_gear: ['#050505', '#222222', '#444444', '#777777'],
        };

        // PERSISTENT DATA FOR PAUSE/MODE SWITCHING
        let persistentData = new Float32Array(256 * 128).fill(0);

        function getDiscTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(16, 16, 15, 0, Math.PI * 2); ctx.fill();
            return new THREE.CanvasTexture(canvas);
        }
        const discTexture = getDiscTexture();

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(60, 50, 60);

        const renderer = new THREE.WebGLRenderer({ antialias: !isMobile });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.06; controls.autoRotate = false; controls.target.set(0, 0, 0);

        scene.add(labelGroup);

        function createTextLabel(text, x, y, z) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 128;
            ctx.font = "bold 50px 'Share Tech Mono', monospace";
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.fillText(text, 128, 80);
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMat = new THREE.SpriteMaterial({ map: texture, transparent: true, opacity: 1.0 });
            const sprite = new THREE.Sprite(spriteMat);
            sprite.scale.set(8, 4, 1);
            sprite.position.set(x, y, z);
            return sprite;
        }

        function updateLabelsAndGrid() {
            if (gridHelper) { scene.remove(gridHelper); gridHelper.geometry?.dispose(); gridHelper.material?.dispose(); }
            labelGroup.children.forEach(c => { if (c.geometry) c.geometry.dispose(); if (c.material) { if (c.material.map) c.material.map.dispose(); c.material.dispose(); } });
            labelGroup.clear();

            const isGridOn = document.getElementById('gridBtn')?.innerText.includes("ON");
            labelGroup.visible = !!isGridOn;
            const depthSize = config.halfDepth ? 50 : 100;
            const vertices = [];

            // TIME LINES
            const zLines = 8;
            const zStep = depthSize / zLines;
            for (let i = 0; i <= zLines; i++) {
                const z = (depthSize / 2) - (i * zStep);
                vertices.push(-50, -2, z, 50, -2, z);

                if (isGridOn && i % 2 === 0) {
                    const tVal = (i * (config.halfDepth ? 0.5 : 1.0) * (5 / zLines)).toFixed(0);
                    const labelText = i === 0 ? "0s" : `-${tVal}s`;
                    labelGroup.add(createTextLabel(labelText, 56, -2, z));
                }
            }

            // FREQ LINES (LOGARITHMIC MATCH)
            const freqs = [50, 100, 200, 500, 1000, 2000, 5000, 10000, 15000, 20000];
            const labeled = [50, 500, 1000, 5000, 10000, 20000];

            freqs.forEach((hz) => {
                const xNorm = Math.pow(hz / 20000, 1 / 2.5); // t^2.5 log scale
                const x = (xNorm * 100) - 50;
                vertices.push(x, -2, -depthSize / 2, x, -2, depthSize / 2);

                if (isGridOn && labeled.includes(hz)) {
                    const lbl = hz >= 1000 ? (hz / 1000) + 'k' : hz;
                    labelGroup.add(createTextLabel(lbl.toString(), x, -2, (depthSize / 2) + 4));
                }
            });

            const gridGeo = new THREE.BufferGeometry();
            gridGeo.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            gridHelper = new THREE.LineSegments(gridGeo, new THREE.LineBasicMaterial({ color: 0x888888, transparent: true, opacity: 0.5 }));
            gridHelper.visible = !!isGridOn;
            scene.add(gridHelper);
        }

        updateLabelsAndGrid();

        // --- POST PROCESSING ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2; bloomPass.strength = 0.25; bloomPass.radius = 0.6;
        const effectFXAA = new ShaderPass(FXAAShader);
        effectFXAA.uniforms['resolution'].value.set(1 / (window.innerWidth * renderer.getPixelRatio()), 1 / (window.innerHeight * renderer.getPixelRatio()));
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);
        if (!isMobile) composer.addPass(effectFXAA);

        function getPaletteColor(t, paletteName) {
            const colors = palettes[paletteName] || palettes.dreamy;
            const c1 = new THREE.Color(colors[0]); const c2 = new THREE.Color(colors[1]); const c3 = new THREE.Color(colors[2]); const c4 = new THREE.Color(colors[3]);
            const finalColor = new THREE.Color();
            if (t < 0.33) finalColor.lerpColors(c1, c2, t / 0.33);
            else if (t < 0.66) finalColor.lerpColors(c2, c3, (t - 0.33) / 0.33);
            else finalColor.lerpColors(c3, c4, (t - 0.66) / 0.34);
            return finalColor;
        }

        function updateBinIndexLUT() {
            if (!analyser) return;
            binIndexLUT = new Uint32Array(config.width);
            const nyquist = audioContext.sampleRate / 2;
            const totalBins = analyser.frequencyBinCount;
            const endBin = Math.floor((20000 / nyquist) * totalBins);
            for (let j = 0; j < config.width; j++) {
                const t = j / (config.width - 1);
                let binIndex = Math.floor(Math.pow(t, 2.5) * endBin);
                binIndexLUT[j] = Math.min(binIndex, totalBins - 1);
            }
        }

        function initGeometry(preserve = true) {
            if (mesh) { scene.remove(mesh); geometry?.dispose(); material?.dispose(); mesh = null; }
            const currentDepth = config.depth; const renderDepth = config.halfDepth ? 50 : 100;
            const totalPoints = config.width * currentDepth;

            if (config.displayMode === 'bars') {
                const posArray = new Float32Array(totalPoints * 2 * 3); const colorArray = new Float32Array(totalPoints * 2 * 3);
                for (let i = 0; i < currentDepth; i++) {
                    for (let j = 0; j < config.width; j++) {
                        const index = (i * config.width + j);
                        const c = getPaletteColor(j / (config.width - 1), config.palette);
                        const x = (j / (config.width - 1) - 0.5) * 100;
                        const z = (i / (currentDepth - 1) - 0.5) * renderDepth;
                        // Height persistence
                        const h = preserve ? persistentData[index] : 0;
                        const v1 = index * 6; posArray[v1] = x; posArray[v1 + 1] = -2; posArray[v1 + 2] = z; colorArray[v1] = c.r; colorArray[v1 + 1] = c.g; colorArray[v1 + 2] = c.b;
                        const v2 = index * 6 + 3; posArray[v2] = x; posArray[v2 + 1] = -2 + h; posArray[v2 + 2] = z; colorArray[v2] = c.r; colorArray[v2 + 1] = c.g; colorArray[v2 + 2] = c.b;
                    }
                }
                geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colorArray, 3));
                material = new THREE.LineBasicMaterial({ vertexColors: true });
                mesh = new THREE.LineSegments(geometry, material);
            } else {
                geometry = new THREE.PlaneGeometry(100, renderDepth, config.width - 1, currentDepth - 1);
                const colors = new Float32Array(geometry.attributes.position.count * 3);
                const pos = geometry.attributes.position.array;
                for (let i = 0; i < currentDepth; i++) {
                    for (let j = 0; j < config.width; j++) {
                        const index = (i * config.width + j);
                        const c = getPaletteColor(j / (config.width - 1), config.palette);
                        colors[index * 3] = c.r; colors[index * 3 + 1] = c.g; colors[index * 3 + 2] = c.b;
                        // Height persistence
                        if (preserve) pos[index * 3 + 2] = persistentData[index];
                    }
                }
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                if (config.displayMode === 'dots') {
                    material = new THREE.PointsMaterial({ vertexColors: true, size: 0.5, map: discTexture, transparent: true, alphaTest: 0.1 });
                    mesh = new THREE.Points(geometry, material);
                } else if (config.displayMode === 'lines') {
                    const indices = [];
                    for (let j = 0; j < config.width; j += 2) { for (let i = 0; i < currentDepth - 1; i++) { indices.push(i * config.width + j, (i + 1) * config.width + j); } }
                    geometry.setIndex(indices);
                    material = new THREE.LineBasicMaterial({ vertexColors: true });
                    mesh = new THREE.LineSegments(geometry, material);
                } else if (config.displayMode === 'wire') {
                    const indices = [];
                    const w = config.width; const d = currentDepth;
                    for (let i = 0; i < d; i++) { for (let j = 0; j < w - 1; j++) { indices.push(i * w + j, i * w + j + 1); } }
                    for (let j = 0; j < w; j++) { for (let i = 0; i < d - 1; i++) { indices.push(i * w + j, (i + 1) * w + j); } }
                    const lineGeo = new THREE.BufferGeometry();
                    lineGeo.setAttribute('position', geometry.attributes.position);
                    lineGeo.setAttribute('color', geometry.attributes.color);
                    lineGeo.setIndex(indices);
                    geometry = lineGeo;
                    material = new THREE.LineBasicMaterial({ vertexColors: true });
                    mesh = new THREE.LineSegments(geometry, material);
                } else {
                    material = new THREE.MeshBasicMaterial({ vertexColors: true, side: THREE.DoubleSide });
                    mesh = new THREE.Mesh(geometry, material);
                }
                mesh.rotation.x = -Math.PI / 2;
            }
            scene.add(mesh);
        }

        initGeometry(false); // First init

        function addListener(id, event, fn) { const el = document.getElementById(id); if (el) el.addEventListener(event, fn); }
        const ampVal = document.getElementById('ampVal'); const depthVal = document.getElementById('depthVal'); const speedVal = document.getElementById('speedVal'); const clickHint = document.getElementById('click-hint');

        addListener('ampSlider', 'input', (e) => { config.amp = parseInt(e.target.value); if (ampVal) ampVal.innerText = config.amp; });
        addListener('speedSlider', 'input', (e) => { config.speedDivisor = 11 - parseInt(e.target.value); if (speedVal) speedVal.innerText = e.target.value; updateLabelsAndGrid(); });
        addListener('depthSlider', 'input', (e) => { if (depthVal) depthVal.innerText = e.target.value; });
        addListener('depthSlider', 'change', (e) => { config.depth = parseInt(e.target.value); initGeometry(true); updateLabelsAndGrid(); });
        addListener('paletteSelect', 'change', (e) => { config.palette = e.target.value; initGeometry(true); });
        addListener('modeSelect', 'change', (e) => { config.displayMode = e.target.value; initGeometry(true); });
        addListener('viewSelect', 'change', (e) => {
            const v = e.target.value;
            if (v === 'iso') camera.position.set(60, 50, 60);
            else if (v === 'front') camera.position.set(0, 20, 80);
            else if (v === 'side') camera.position.set(90, 20, 0);
            else if (v === 'top') camera.position.set(0, 100, 0);
            controls.target.set(0, 0, 0); controls.update();
        });
        addListener('sizeBtn', 'click', (e) => { config.halfDepth = !config.halfDepth; e.target.innerText = config.halfDepth ? i18n[currentLang].size_half : i18n[currentLang].size_full; initGeometry(true); updateLabelsAndGrid(); });
        addListener('gridBtn', 'click', (e) => { const isVisible = !gridHelper.visible; gridHelper.visible = isVisible; labelGroup.visible = isVisible; e.target.innerText = isVisible ? i18n[currentLang].grid_on : i18n[currentLang].grid_off; e.target.classList.toggle('active'); });
        addListener('srcBtn', 'click', () => {
            if (isMobile) { alert('System Audio not supported on Mobile'); return; }
            audioSource = (audioSource === 'mic' ? 'system' : 'mic');
            initAudio(true); setLang(currentLang);
        });
        addListener('rotBtn', 'click', (e) => {
            rotState = (rotState + 1) % 3;
            if (rotState === 0) { controls.autoRotate = false; e.target.classList.remove('active'); }
            else if (rotState === 1) { controls.autoRotate = true; controls.autoRotateSpeed = 0.2; e.target.classList.add('active'); }
            else { controls.autoRotate = true; controls.autoRotateSpeed = 0.6; e.target.classList.add('active'); }
            setLang(currentLang);
        });
        addListener('fsBtn', 'click', (e) => {
            const de = document.documentElement;
            if (!document.fullscreenElement) { if (de.requestFullscreen) de.requestFullscreen().catch(e => console.warn(e)); }
            else { if (document.exitFullscreen) document.exitFullscreen().catch(e => console.warn(e)); }
        });
        addListener('fftSelect', 'change', (e) => { if (analyser) { analyser.fftSize = parseInt(e.target.value); dataArray = new Uint8Array(analyser.frequencyBinCount); updateBinIndexLUT(); } });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Tab') { e.preventDefault(); isUiVisible = !isUiVisible; document.getElementById('ui-container').style.transform = isUiVisible ? 'translateX(0)' : 'translateX(-100%)'; }
            if (e.code === 'Space') { e.preventDefault(); isPaused = !isPaused; }
        });

        async function initAudio(force = false) {
            if (isRunning && !force) return;
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // FORCE RESUME ON CLICK
                await audioContext.resume();

                if (audioSource === 'mic') mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                else mediaStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });

                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = parseInt(document.getElementById('fftSelect').value);
                analyser.smoothingTimeConstant = 0.8;
                source.connect(analyser); dataArray = new Uint8Array(analyser.frequencyBinCount);
                updateBinIndexLUT();
                isRunning = true;
                document.getElementById('click-hint').style.display = 'none';
                animate();
            } catch (err) { console.error(err); document.getElementById('click-hint').innerText = "ACCESS DENIED"; }
        }

        window.addEventListener('load', () => {
            // Simple robust start: click anywhere -> init
            document.body.addEventListener('click', () => initAudio(), { once: true });
        });

        function animate() {
            requestAnimationFrame(animate); controls.update(); composer.render();
            if (!isRunning || !analyser || !binIndexLUT) return;

            // Only update data if NOT paused
            if (!isPaused && frameCount % config.speedDivisor === 0) {
                analyser.getByteFrequencyData(dataArray);
                // Optimized shift using copyWithin
                persistentData.copyWithin(0, config.width, config.width * config.depth);

                const gate = 8;
                for (let j = 0; j < config.width; j++) {
                    let val = dataArray[binIndexLUT[j]];
                    persistentData[(config.depth - 1) * config.width + j] = (val < gate ? 0 : val / 255.0) * config.amp;
                }
            }
            if (!isPaused) frameCount++;

            // ALWAYS update visual lerp (even if paused, to settle/switch modes)
            const lp = 0.2;
            if (config.displayMode === 'bars' && geometry.attributes.position) {
                const p = geometry.attributes.position.array;
                // Safety check length
                const len = Math.min(p.length, persistentData.length * 6);
                // Loop limit must match persistentData size
                for (let i = 0; i < config.width * config.depth; i++) {
                    p[i * 6 + 4] += (-2 + persistentData[i] - p[i * 6 + 4]) * lp;
                }
            } else if (geometry.attributes.position) {
                const p = geometry.attributes.position.array;
                const len = Math.min(p.length / 3, persistentData.length);
                for (let i = 0; i < len; i++) {
                    p[i * 3 + 2] += (persistentData[i] - p[i * 3 + 2]) * lp;
                }
            }
            if (geometry) geometry.attributes.position.needsUpdate = true;
        }

        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix();
            adjustCameraForScreen();
            effectFXAA.uniforms['resolution'].value.set(1 / (window.innerWidth * renderer.getPixelRatio()), 1 / (window.innerHeight * renderer.getPixelRatio()));
        });

        function adjustCameraForScreen() {
            const aspect = window.innerWidth / window.innerHeight;
            if (aspect < 1) camera.position.set(80, 70, 80); else camera.position.set(60, 50, 60);
            controls.target.set(0, 0, 0);
        }

        setLang('en');
    </script>
</body>

</html>